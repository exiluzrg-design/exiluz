<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Env√≠o - Exiluz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- estilos globales -->
  <link rel="stylesheet" href="assets/css/style.css" />

  <!-- Banner + Header -->
  <link rel="stylesheet" href="assets/css/header-banner.css" />
  <script src="assets/js/header-banner.js" defer></script>
</head>

<body class="page--checkout">

  <div id="header-root"></div>

  <main class="cart-main container">

    <!-- Barra de pasos -->
    <div class="checkout-steps">
      <span class="step step--done">Carrito</span>
      <span class="step step--done">Entrega</span>
      <span class="step step--current">Pago</span>
    </div>

    <h1 class="cart-title">Entrega</h1>

    <div class="cart-layout">

      <!-- COLUMNA IZQUIERDA: datos + opciones de env√≠o -->
      <section class="checkout-form">

        <h2>Datos de contacto</h2>

        <!-- Email ya elegido, como en Tienda Nube -->
        <div class="checkout-email-box">
          <span id="envio-email-text">tuemail@ejemplo.com</span>
          <a href="checkout.html" class="checkout-email-change">Cambiar</a>
        </div>

        <label class="form-checkbox">
          <input type="checkbox" id="envio-newsletter"/>
          <span>Quiero recibir ofertas y novedades por e-mail</span>
        </label>

        <h2>Entrega</h2>

        <div class="checkout-cp-row">
          <span>C√≥digo Postal: <strong id="envio-cp-text">0000</strong></span>
          <a href="checkout.html" class="btn btn-outline-sm">Cambiar CP</a>
        </div>

        <!-- Opciones de env√≠o (simplificadas) -->
        <form id="envio-form" class="checkout-form-inner">

          <div class="shipping-option">
            <label>
              <input type="radio" name="envio" value="correo" checked />
              <span>
                <strong>Env√≠o a domicilio</strong> ‚Äî Env√≠o est√°ndar<br>
                <small>Llega entre 3 y 7 d√≠as h√°biles</small>
              </span>
            </label>
            <div class="shipping-price">$0 (promo lanzamiento)</div>
          </div>

          <div class="shipping-option">
            <label>
              <input type="radio" name="envio" value="retiro" />
              <span>
                <strong>Retiro en Jugueter√≠a Guadis</strong><br>
                <small>Perito Moreno 238, R√≠o Grande (Centro)<br>
                Lunes a viernes, de 09:00 a 18:00</small>
              </span>
            </label>
            <div class="shipping-price">Gratis</div>
          </div>

          <!-- üîµ AHORA S√ç: este bot√≥n va a Mercado Pago -->
          <button type="submit" class="btn btn-primary btn-full">
            Continuar para el pago
          </button>

          <p id="envio-message" class="checkout-message"></p>
        </form>

      </section>

      <!-- COLUMNA DERECHA: resumen del pedido -->
      <aside class="cart-summary">
        <h2>Resumen</h2>

        <div class="summary-row">
          <span>Llavero Elijo Creer √ó 1</span>
          <span id="envio-item-price">$18.000</span>
        </div>

        <div class="summary-row">
          <span>Subtotal:</span>
          <span id="envio-subtotal">$18.000</span>
        </div>

        <div class="summary-row">
          <span>Env√≠o:</span>
          <span id="envio-shipping">Gratis</span>
        </div>

        <div class="summary-total">
          <span>Total:</span>
          <span id="envio-total">$18.000</span>
        </div>

        <button class="btn btn-link" type="button">
          Agregar cup√≥n de descuento
        </button>
      </aside>

    </div>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <small>¬© <span id="year"></span> Exiluz. Todos los derechos reservados.</small>
    </div>
  </footer>

  <script>
    // Cargar datos guardados en el paso anterior
    (function loadCheckoutData() {
      try {
        const email = localStorage.getItem('exiluz_checkout_email') || '';
        const cp = localStorage.getItem('exiluz_checkout_cp') || '';
        const newsletter = localStorage.getItem('exiluz_checkout_newsletter') === '1';

        if (email) {
          document.getElementById('envio-email-text').textContent = email;
        }
        if (cp) {
          document.getElementById('envio-cp-text').textContent = cp;
        }
        document.getElementById('envio-newsletter').checked = newsletter;
      } catch (err) {
        console.warn('No se pudieron leer los datos de checkout', err);
      }
    })();

    // üîµ AHORA ESTE SUBMIT CREA LA PREFERENCIA Y REDIRIGE A MP
    document.getElementById('envio-form')?.addEventListener('submit', async function(e) {
      e.preventDefault();

      const selected = document.querySelector('input[name="envio"]:checked');
      if (!selected) {
        document.getElementById('envio-message').textContent =
          'Eleg√≠ una opci√≥n de env√≠o para continuar.';
        return;
      }

      const modoEnvio = selected.value;

      let email = '';
      let cp = '';
      let newsletter = false;

      try {
        email = localStorage.getItem('exiluz_checkout_email') || '';
        cp = localStorage.getItem('exiluz_checkout_cp') || '';
        newsletter = localStorage.getItem('exiluz_checkout_newsletter') === '1';
      } catch (err) {
        console.warn('No se pudieron leer los datos de checkout', err);
      }

      if (!email || !cp) {
        document.getElementById('envio-message').textContent =
          'Faltan datos de contacto. Volv√© al paso anterior.';
        return;
      }

      document.getElementById('envio-message').textContent = 'Preparando el pago...';

      try {
        const resp = await fetch('/api/checkout-mp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email,
            cp,
            newsletter,
            shipping_mode: modoEnvio,
            // Por ahora 1 unidad fija; despu√©s lo conectamos al carrito real
            items: [
              {
                title: 'Llavero Elijo Creer',
                quantity: 1,
                unit_price: 18000,
                currency_id: 'ARS'
              }
            ]
          })
        });

        if (!resp.ok) {
          throw new Error('Error al crear la preferencia de pago');
        }

        const data = await resp.json();
        if (!data.init_point) {
          throw new Error('Respuesta inv√°lida del servidor');
        }

        // üëâ Redirigir a Mercado Pago
        window.location.href = data.init_point;

      } catch (err) {
        console.error(err);
        document.getElementById('envio-message').textContent =
          'No pudimos iniciar el pago. Prob√° de nuevo en unos minutos.';
      }
    });
  </script>
</body>
</html>
